# Note:
#   Image purpose â€º source code isolation for CI build
#   This container use a copy project source code strategy instead of using the mounting volume

FROM bats/bats:latest as bats-core-base-img

FROM ubuntu:latest as final

ARG PROJECT_ROOT
ENV PROJECT_ROOT=${PROJECT_ROOT}
ENV SRC_CODE_PATH="/code/${PROJECT_ROOT}/"

LABEL org.opencontainers.image.authors="luc.coupal.1@ulaval.ca"

SHELL ["/bin/bash", "-e", "-c"]
ARG DEBIAN_FRONTEND=noninteractive

# ====Begin========================================================================================================
# ....Setup timezone and localization..............................................................................
# change the locale from POSIX to UTF-8
RUN apt-get update && \
    apt-get install --assume-yes --no-install-recommends \
        locales && \
    rm -rf /var/lib/apt/lists/*

RUN locale-gen en_US en_US.UTF-8 && update-locale LC_ALL=en_US.UTF-8 LANG=en_US.UTF-8
ENV LANG=en_US.UTF-8
ENV PYTHONIOENCODING=utf-8

# ====Begin========================================================================================================

# ....Install development utilities................................................................................
RUN apt-get update \
    && apt-get install --assume-yes --no-install-recommends \
        sudo \
        lsb-release \
        curl \
        wget \
        ca-certificates \
        git \
        tree \
        zip gzip tar unzip \
        fontconfig \
        software-properties-common \
    && rm -rf /var/lib/apt/lists/*

# ....Install bats-core............................................................................................
RUN ln -s /opt/bats/bin/bats /usr/local/bin/bats
COPY --from=bats-core-base-img /opt/bats/ /opt/bats/
COPY --from=bats-core-base-img /usr/lib/bats/ /usr/lib/bats/

#RUN git clone https://github.com/bats-core/bats-core.git \
#    cd bats-core \
#    ./install.sh /usr/local

RUN apt-get update \
    && apt-get install --assume-yes --no-install-recommends \
        tini \
    && rm -rf /var/lib/apt/lists/*

# ....Setup project source code....................................................................................
COPY . $SRC_CODE_PATH
#RUN chown -R $(whoami) $SRC_CODE_PATH

# ====End==========================================================================================================
WORKDIR $SRC_CODE_PATH

ENTRYPOINT [ "/usr/bin/tini", "--", "bash", "bats" ]
